(function(m,u){typeof exports=="object"&&typeof module<"u"?module.exports=u():typeof define=="function"&&define.amd?define(u):(m=typeof globalThis<"u"?globalThis:m||self,m.WaterMask=u())})(this,function(){"use strict";const u={display:"block !important",width:"100% !important",height:"100% !important","max-width":"unset !important","max-height":"unset !important",position:"absolute !important",top:"0 !important",left:"0 !important",padding:"0 !important",margin:"0 !important","pointer-events":"none !important","z-index":"1 !important"},y=3,f=12;class E{constructor(){this.cacheMap=[],this.timer=null}init(t,n={}){var d,o,h;const i=!t||Object.prototype.toString.call(t)==="[object HTMLDivElement]"?t:document.querySelector(t);if(!i)return;const e={...{texts:[],include:[],exclude:[],zIndex:1,style:{}},...n};if(e.texts=(((d=e.texts)==null?void 0:d.filter(c=>typeof c=="string"))||[]).slice(0,y),!e.texts.length){this.clear(null,i);return}if(e.texts.length==1){const c=e.texts[0];e.texts=[c.slice(0,f),c.slice(f,f*2),c.slice(f*2,f*3)].filter(b=>!!b)}else e.texts=e.texts.map(c=>(c=c.slice(0,f),c));e.include=((o=e.include)==null?void 0:o.filter(c=>Object.prototype.toString.call(c)==="[object RegExp]"||Object.prototype.toString.call(c)==="[object String]"))||[],e.exclude=((h=e.exclude)==null?void 0:h.filter(c=>Object.prototype.toString.call(c)==="[object RegExp]"||Object.prototype.toString.call(c)==="[object String]"))||[],e.zIndex=parseInt(e.zIndex||1),e.style=e.style||{};let l={$el:i,options:e},{item:r,index:s}=this.find(i);r?(this.cacheMap[s].options=e,this.addWatermark(this.cacheMap[s],!0)):(this.cacheMap.push(l),this.addWatermark(l,!0)),this.handleTimer()}addWatermark(t,n=!1){var c,b;if(!(t!=null&&t.$el)||!t.options)return;const i=t.$el,a=t.options,e=i.childNodes,l=e.length;let r;for(let p=l-1;p>=0;p--)if((c=e[p])!=null&&c.getAttribute&&((b=e[p])==null?void 0:b.getAttribute("name"))==="watermask"){r=e[p];break}if(this.checkPathHide(a)){r&&(r.style.display="none");return}if(!n&&this.checkStyle(r,a)&&this.checkBotherNode(i,t))return;const d=this.handleImageData(a),o={...u,background:d,"z-index":`${a.zIndex} !important`};let h="";for(let p in o)h+=`${p}: ${o[p]};`;r?(r.setAttribute("style",h),console.log("watermask updated.")):(r=document.createElement("div"),r.setAttribute("name","watermask"),r.setAttribute("style",h),i.appendChild(r),console.log("watermask added."))}handleImageData(t){const n=t.texts,i=t.style||{};let a=document.createElement("canvas");a.width=t.style.width||400,a.height=t.style.height||350;let e=10,l=a.height-120,r=a.height/10;const s=a.getContext("2d"),d=i.rotate&&i.rotate<=0?parseFloat(i.rotate):-35;s.rotate(d*Math.PI/180),s.font=i.font||"lighter 20px Vedana",s.fillStyle=i.fillStyle||"rgba(200, 200, 200, 0.35)",s.textAlign=i.textAlign||"center",s.textBaseline=i.textBaseline||"middle";for(let o=0;o<n.length;o++)s.fillText(n[o],e,l),l+=r;return"url("+a.toDataURL("image/png")+") left top repeat"}checkStyle(t,n){var r,s;if(!t)return!1;const i=t.getAttribute("style");let a={};i.split(";").forEach(d=>{var h;const o=d.split(":");a[o[0].trim()]=((h=o[1])==null?void 0:h.trim())||""});const e=!!((s=(r=t==null?void 0:t.style)==null?void 0:r.background)!=null&&s.match(/data:image\/png;base64/g));let l=!0;return e&&Object.keys(u).forEach(d=>{let o=!0;if(d==="z-index"){const h=(a[d]||"").replace(" !important","").trim();o=!!h&&h-0>=n.zIndex}if(!o||d!="z-index"&&u[d]!=a[d])return l=!1,!1}),e&&l}checkBotherNode(t,n){if(t){const i=t.childNodes.length;let a=n.options.zIndex;for(let e=i-1;e>=0;e--){const l=t.childNodes[e],r=l.style["z-index"]||"";r!=""&&(r==a&&l.getAttribute&&l.getAttribute("name")!="watermask"||r>a)&&(a=parseInt(r)+1)}if(n.options.zIndex!=a)return n.options.zIndex=a,!1}return!0}checkPathHide(t){var i,a,e;let n=!1;return(i=t.exclude)==null||i.forEach(l=>{if(location.pathname===l||Object.prototype.toString.call(l)==="[object RegExp]"&&location.pathname.match(l))return n=!0,!1}),!n&&((a=t.include)!=null&&a.length)&&(n=!((e=t.include)!=null&&e.some(l=>location.pathname===l||Object.prototype.toString.call(l)==="[object RegExp]"&&!!location.pathname.match(l)))),n}handleTimer(t=!1){t?!this.cacheMap.length&&this.timer&&clearInterval(this.timer):(this.timer&&clearInterval(this.timer),this.cacheMap.length&&(this.timer=setInterval(()=>{this.cacheMap.forEach(n=>{this.addWatermark(n)})},3e3)))}find(t){let n={item:null,index:-1};return Object.prototype.toString.call(t)!=="[object HTMLDivElement]"||this.cacheMap.forEach((i,a)=>{if(t.isSameNode(i.$el))return n={item:i,index:a},!1}),n}clear(t,n){var l,r;const i=t?t.$el:!n||Object.prototype.toString.call(n)==="[object HTMLDivElement]"?n:document.querySelector(n);if(!i)return;if(!t){let{index:s}=this.find(i);s>-1&&this.cacheMap.splice(s)}this.handleTimer(!0);const a=i.childNodes,e=a.length;for(let s=e-1;s>=0;s--)(l=a[s])!=null&&l.getAttribute&&((r=a[s])==null?void 0:r.getAttribute("name"))==="watermask"&&a[s].remove();console.log("watermask clear.")}clearAll(){this.cacheMap.forEach(t=>{this.clear(t)})}}const g=new E;return{install(x,t={}){x.directive("watermask",{bind(n,i){g.init(n,{...t,...i.value||{}})},update(n,i){g.init(n,{...t,...i.value||{}})},unbind(n){g.clear(null,n)}})},init(x,t){g.init(x,t)},clear(x){g.clear(null,x)},clearAll(){g.clearAll()}}});
